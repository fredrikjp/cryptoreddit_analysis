name: Run Kafka Producer and Consumer
on:
  schedule:
    - cron: '0 * * * *'  # Runs every hour
  workflow_dispatch:  # Allows manual triggering
  push:
    branches:
      - master  # Matches your specified branch
jobs:
  kafka-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install docker-compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image for Kafka job
        run: docker build -t kafka-job .
      - name: Start Kafka with Docker Compose
        run: |
          docker-compose up -d
          sleep 90  # Wait for Kafka and Zookeeper
      - name: Check Kafka port
        run: |
          docker-compose exec kafka kafka-topics --bootstrap-server kafka:9092 --list
      - name: Run producer
        run: docker run --rm --network reddit-sentiment kafka-job python producer/reddit_stream_producer.py
        env:
          KAFKA_BOOTSTRAP_SERVERS: kafka:9092
          KAFKA_TOPIC: reddit_comments
      - name: Run consumer
        run: docker run --rm --network reddit-sentiment kafka-job python consumer/sentiment_consumer.py
        env:
          KAFKA_BOOTSTRAP_SERVERS: kafka:9092
          KAFKA_TOPIC: reddit_comments
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kafka-outputs
          path: |
            messages.txt
            sentiments.json
      - name: Stop Kafka
        run: docker-compose down
