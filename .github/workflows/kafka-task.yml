name: Run Kafka Producer and Consumer

on:
  schedule:
    - cron: '0 * * * *'  # Runs every hour
  workflow_dispatch:  # Allows manual triggering of the workflow from GitHub UI
  push:
    branches:
      - master  # Runs on pushes to the main branch

jobs:
  kafka-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Start Kafka with Docker Compose
        run: |
          export KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
          docker compose up -d
          sleep 60  # Wait for Kafka and Zookeeper to start

      - name: Build Docker image for Kafka job
        run: |
            docker build -t kafka-job .

      - name: Check Kafka port
        run: |
          docker compose exec kafka bash -c "kafka-topics --bootstrap-server localhost:9092 --list" 
      - name: Run producer.py
        run: |
          docker run kafka-job python producer/reddit_stream_producer.py &
        env:
          KAFKA_BOOTSTRAP_SERVERS: kafka:9092
          KAFKA_TOPIC: reddit_comments

      - name: Run consumer.py
        run: |
          docker run kafka-job python consumer/sentiment_consumer.py
        env:
          KAFKA_BOOTSTRAP_SERVERS: kafka:9092
          KAFKA_TOPIC: reddit_comments
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Keep alive for 2 minutes
        run: sleep 120
